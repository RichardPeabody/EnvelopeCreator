<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>C5 Envelope Creator — Wizard</title>
  <style>
    :root { --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --accent:#2f46ff; --border:#e5e7eb; --shadow:0 10px 30px rgba(15,23,42,.08); }
    [data-theme="dark"]{ --bg:#0b1020; --card:#0f152b; --text:#eef2ff; --muted:#9aa3b2; --border:#1e294a; --shadow:0 10px 30px rgba(0,0,0,.6); }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{ margin:0; background:var(--bg); color:var(--text); font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    header{ position:sticky; top:0; z-index:20; background:linear-gradient(135deg,#0b3bff 0%,#7a9bff 100%); color:white; padding:14px 18px; box-shadow:var(--shadow); }
    header .row{ display:flex; align-items:center; gap:12px; justify-content:space-between; max-width:1200px; margin:0 auto; }
    h1{ font-size:18px; margin:0; letter-spacing:.2px; font-weight:700; }

    main{ max-width:1200px; margin:16px auto; padding:0 16px; display:grid; grid-template-columns:1fr 1.1fr; gap:16px; }
    @media (max-width: 1024px){ main{ grid-template-columns:1fr; } }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:16px; }
    .card h2{ margin:0 0 12px; font-size:16px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; cursor:pointer; }
    input[type="file"], textarea, input[type="number"], input[type="text"], select{ width:100%; padding:11px 12px; border:1px solid var(--border); border-radius:10px; background:transparent; color:inherit; }
    textarea{ min-height:110px; resize:vertical; font-family:inherit; }
    .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .btn{ appearance:none; border:0; padding:12px 14px; border-radius:12px; background:var(--accent); color:white; cursor:pointer; font-weight:700; letter-spacing:.2px; box-shadow:0 8px 18px rgba(47,70,255,.25); }
    .btn.secondary{ background:transparent; color:var(--accent); border:1px solid var(--accent); box-shadow:none; }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .status{ font-size:12px; padding:8px 10px; border-radius:10px; background:#e9efff; color:#0b3bff; }
    [data-theme="dark"] .status{ background:#10224a; color:#89a4ff; }

    .steps{ display:grid; grid-template-columns:repeat(6, 1fr); gap:8px; margin-bottom:12px; }
    .step{ padding:10px 8px; border-radius:12px; background:#e5e7eb; color:#475569; font-weight:700; font-size:12px; opacity:.75; text-align:center; user-select:none; }
    .step.active{ opacity:1; background:#c7d2fe; color:#1e3a8a; }
    .step.done{ opacity:1; background:#bbf7d0; color:#064e3b; }

    .previewWrap{ position:relative; border-radius:14px; overflow:hidden; border:1px solid var(--border); background: repeating-conic-gradient(#0000 0 90deg, #f3f4f6 0 180deg) 50%/20px 20px; }
    [data-theme="dark"] .previewWrap{ background: repeating-conic-gradient(#0000 0 90deg, #111827 0 180deg) 50%/20px 20px; }
    canvas{ display:block; width:100%; height:auto; background:white; }

    .zoombar{ display:flex; align-items:center; gap:10px; margin-top:10px; color:var(--muted); }
    input[type="range"]{ width:220px; }

    .hidden{ display:none !important; }
    .error{ color:#b91c1c; font-size:12px; margin-top:6px; }

    @media (max-width:520px){ .step{ font-size:11px; padding:8px 6px; } }

    .btn.review { border:2px dashed var(--accent); background:transparent; color:var(--accent); }
    .muted{ color:var(--muted); font-size:12px; }
    .drop{ margin-top:8px; padding:10px; border:1px dashed var(--border); border-radius:10px; text-align:center; }
    .drop.drag{ border-color: var(--accent); background: rgba(47,70,255,.05); }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <h1>✉️ C5 Envelope Creator — Wizard</h1>
      <div class="controls">
        <button id="themeToggle" class="btn secondary" title="Toggle dark mode">Toggle theme</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Wizard Column -->
    <section class="card" id="wizard">
      <div class="steps">
        <div class="step" id="s1">1. Mode</div>
        <div class="step" id="s2">2. Data</div>
        <div class="step" id="s3">3. Font</div>
        <div class="step" id="s4">4. Return</div>
        <div class="step" id="s5">5. Options</div>
        <div class="step" id="s6">6. Preview & PDF</div>
      </div>

      <!-- Step 1: Mode -->
      <div id="step1">
        <h2>Single address or multiple addresses?</h2>
        <label><input type="radio" name="mode" id="modeSingle" /> Single address</label>
        <label><input type="radio" name="mode" id="modeMulti" /> Multiple addresses (upload a spreadsheet)</label>
        <div id="singleWrap" class="hidden" style="margin-top:10px;">
          <label>Enter the recipient name and address (one line per row)</label>
          <textarea id="singleAddress" placeholder="Full Name&#10;Address line 1&#10;Address line 2&#10;Town/City&#10;Postcode&#10;Country"></textarea>
        </div>
        <div id="errMode" class="error hidden"></div>
        <div class="toolbar" style="margin-top:14px;">
          <button id="nextMode" class="btn" disabled>Next ▷</button>
        </div>
      </div>

      <!-- Step 2: Data (multi only) -->
      <div id="step2" class="hidden">
        <h2>Upload your data (.xlsx or .csv)</h2>
        <p class="muted" style="margin-top:-6px">Column 1 = Full Name, Columns 2+ = Address lines</p>
        <input id="fileXlsx" type="file" accept=".xlsx,.csv" />
        <div class="drop" id="drop">or drag a file here</div>
        <label style="margin-top:12px">Has header row?</label>
        <select id="hasHeader"><option value="yes">Yes</option><option value="no">No</option></select>
        <div id="err1" class="error hidden"></div>
        <div class="toolbar" style="margin-top:14px;">
          <button id="next1" class="btn" disabled>Next ▷</button>
        </div>
      </div>

      <!-- Step 3: Font -->
      <div id="step3" class="hidden">
        <h2>Font</h2>
        <label><input type="checkbox" id="useCustomFont" /> Use a custom TTF (upload below)</label>
        <input id="fileTtf" type="file" accept=".ttf" class="hidden" />
        <p class="muted">If unchecked, the PDF uses built-in Helvetica and the preview uses your system font.</p>
        <div id="err2" class="error hidden"></div>
        <div class="toolbar" style="margin-top:14px;">
          <button id="back2" class="btn secondary">◁ Back</button>
          <button id="next2" class="btn">Next ▷</button>
        </div>
        <div id="statusInline" class="status" style="margin-top:8px;"></div>
      </div>

      <!-- Step 4: Return (optional) -->
      <div id="step4" class="hidden">
        <h2>Return Address (top-left, optional)</h2>
        <label><input type="checkbox" id="useReturn" /> Print a return address at the top left</label>
        <div id="returnBlockWrap" class="hidden">
          <label>Return address (each line on its own row)</label>
          <textarea id="returnBlock" placeholder="Return Address:&#10;Your Name&#10;Street&#10;Town, County, POSTCODE, Country"></textarea>
          <label><input type="checkbox" id="rememberReturn" /> Remember this return address on this device</label>
        </div>
        <div id="err3" class="error hidden"></div>
        <div class="toolbar" style="margin-top:14px;">
          <button id="back3" class="btn secondary">◁ Back</button>
          <button id="next3" class="btn">Next ▷</button>
        </div>
      </div>

      <!-- Step 5: Options -->
      <div id="step5" class="hidden">
        <h2>Print Options</h2>
        <div class="row2">
          <div>
            <label>Recipient & return colour</label>
            <select id="inkPreset">
              <option value="black" selected>Black (default)</option>
              <option value="blueblack">Blue-Black (#00004D)</option>
              <option value="blue">Blue</option>
              <option value="red">Red</option>
              <option value="orange">Orange</option>
            </select>
          </div>
          <div>
            <label>Recipient font size (pt)</label>
            <input id="fsRecipient" type="number" value="24" min="8" max="72" />
          </div>
          <div>
            <label>Return font size (pt)</label>
            <input id="fsReturn" type="number" value="10" min="6" max="24" />
          </div>
        </div>
        <div id="err4" class="error hidden"></div>
        <div class="toolbar" style="margin-top:14px;">
          <button id="back4" class="btn secondary">◁ Back</button>
          <button id="toPreview" class="btn">Next ▷</button>
        </div>
      </div>

      <!-- Step 6: Preview & PDF -->
      <div id="step6" class="hidden">
        <h2>Preview & PDF</h2>
        <div class="toolbar" id="controlBar" style="margin-bottom:10px;">
          <button id="btnBackPreview" class="btn secondary" title="Go back to settings">◁ Back to settings</button>
          <span class="status" id="status">Ready.</span>
          <span id="counter" class="muted" style="margin-left:auto"></span>
          <button id="btnGenerate" class="btn" disabled>⤓ Generate PDF</button>
        </div>
        <div id="statusPreview" class="status" style="margin:8px 0;"></div>
        <div class="zoombar">
          <span>Zoom</span>
          <input id="zoom" type="range" min="60" max="160" value="100" />
          <span id="zoomLabel">100%</span>
        </div>
      </div>
    </section>

    <!-- Preview Column -->
    <section class="card hidden" id="previewCard">
      <h2>Live Preview (C5 landscape, 229 × 162 mm)</h2>
      <div class="toolbar" id="reviewBar" style="margin-bottom:10px;">
        <button id="btnPrev" class="btn review" disabled title="Previous address in review">Review ◀ Prev</button>
        <button id="btnNext" class="btn review" disabled title="Next address in review">Review Next ▶</button>
      </div>
      <div class="previewWrap" id="previewWrap">
        <canvas id="preview" width="2290" height="1620"></canvas>
      </div>
      <div class="muted" style="margin-top:8px;">Default font is built-in Helvetica unless you upload a .ttf. Selected colour applies to both <b>recipient and return</b> addresses.</div>
    </section>
  </main>

  <!-- Libraries -->
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  (function(){
    // ===== Helpers & state =====
    const MM_PER_IN = 25.4, PT_PER_IN = 72;
    const ENVELOPE_W_MM = 229, ENVELOPE_H_MM = 162; // C5
    const REC_X_IN = 2, REC_TOP_IN = 3;          // recipient offset (inches from top-left)
    const RET_X_IN = 0.5, RET_Y_IN = 0.5;        // return offset (inches from top-left)
    let pxPerMM = 10; // canvas: 2290x1620 ⇒ ~10 px/mm

    const $ = s => document.querySelector(s);
    const els = {
      steps:[ $('#s1'),$('#s2'),$('#s3'),$('#s4'),$('#s5'),$('#s6') ],
      step1:$('#step1'), step2:$('#step2'), step3:$('#step3'), step4:$('#step4'), step5:$('#step5'), step6:$('#step6'),
      modeSingle:$('#modeSingle'), modeMulti:$('#modeMulti'), singleWrap:$('#singleWrap'), singleAddress:$('#singleAddress'), nextMode:$('#nextMode'), errMode:$('#errMode'),
      fileXlsx:$('#fileXlsx'), hasHeader:$('#hasHeader'), next1:$('#next1'), err1:$('#err1'), drop:$('#drop'),
      useCustomFont:$('#useCustomFont'), fileTtf:$('#fileTtf'), back2:$('#back2'), next2:$('#next2'), err2:$('#err2'),
      useReturn:$('#useReturn'), returnBlockWrap:$('#returnBlockWrap'), returnBlock:$('#returnBlock'), rememberReturn:$('#rememberReturn'), back3:$('#back3'), next3:$('#next3'), err3:$('#err3'),
      fsRecipient:$('#fsRecipient'), fsReturn:$('#fsReturn'), inkPreset:$('#inkPreset'), back4:$('#back4'), toPreview:$('#toPreview'), err4:$('#err4'),
      status:$('#status'), counter:$('#counter'), btnBackPreview:$('#btnBackPreview'), btnPrev:$('#btnPrev'), btnNext:$('#btnNext'), btnGenerate:$('#btnGenerate'),
      zoom:$('#zoom'), zoomLabel:$('#zoomLabel'),
      wrap:$('#previewWrap'), canvas:$('#preview'), previewCard:$('#previewCard'),
      themeToggle:$('#themeToggle')
    };

    const ctx = els.canvas.getContext('2d');
    const mmToPx = mm => Math.round(mm * pxPerMM);
    const inToPx = inch => Math.round(inch * pxPerMM * MM_PER_IN);
    const mmToPt = mm => (mm / MM_PER_IN) * PT_PER_IN;
    const ptToPx = pt => pt * ((pxPerMM * MM_PER_IN) / PT_PER_IN); // pt → px for preview

    function setStatus(msg){
      if(els.status) els.status.textContent = msg;            // Step 6 pill (transient)
      const si = document.getElementById('statusInline');     // Step 3 inline pill
      if (si) si.textContent = msg;
    }
    function setFontStatus(msg){
      const si = document.getElementById('statusInline');     // Step 3 inline pill
      if (si) si.textContent = msg;
      const sp = document.getElementById('statusPreview');    // Step 6 persistent line
      if (sp) sp.textContent = msg;
    }

    const parseColourName = name => {
      switch(name){
        case 'blueblack': return {r:0,g:0,b:77};
        case 'blue':      return {r:0,g:87,b:255};
        case 'red':       return {r:227,g:27,b:35};
        case 'orange':    return {r:249,g:115,b:22};
        default:          return {r:0,g:0,b:0};
      }
    };

    // match canvas to mm
    (function resizeCanvas(){ els.canvas.width = mmToPx(ENVELOPE_W_MM); els.canvas.height = mmToPx(ENVELOPE_H_MM); })();

    let rows = []; let idx = 0; let mode = null;
    let ttfBytes = null; let fontName = null; let customFontLoaded = false; let ttfFileName = null; let ttfBase64 = null;

    function updateProgress(n){
      els.steps.forEach((s,i)=>{ s.classList.remove('done','active'); if(i===n-1) s.classList.add('active'); if(i < n-1) s.classList.add('done'); });
    }
    function setStep(n){
      [els.step1,els.step2,els.step3,els.step4,els.step5,els.step6].forEach((c,i)=> c.classList.toggle('hidden', i!==n-1));
      updateProgress(n);
      els.previewCard.classList.toggle('hidden', n!==6);
      setStatus(`On step ${n}`);
      if(n===6){ drawPreview(); updateButtons(); applyZoom(); }
    }

    function updateButtons(){
      const ready = rows.length>0;
      els.btnGenerate.disabled = !ready;
      els.btnPrev.disabled = idx<=0;
      els.btnNext.disabled = idx>=rows.length-1;
      els.counter.textContent = ready ? `Preview ${idx+1} / ${rows.length}` : '';
    }

    // Theme
    els.themeToggle.addEventListener('click', ()=>{
      const cur=document.documentElement.getAttribute('data-theme')||'light';
      document.documentElement.setAttribute('data-theme',cur==='light'?'dark':'light');
    });

    // Zoom
    function applyZoom(){ const z=parseInt(els.zoom.value,10)/100; els.wrap.style.transform=`scale(${z})`; els.wrap.style.transformOrigin='top left'; els.zoomLabel.textContent=`${Math.round(z*100)}%`; }
    els.zoom.addEventListener('input', applyZoom);

    // Step 1: Mode
    function parseSingleIntoRows(){
      const lines = els.singleAddress.value.replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
      rows = lines.length ? [{ name: lines[0], lines: lines.slice(1) }] : [];
      updateButtons();
    }
    function validateMode(){
      if(els.modeSingle.checked){
        mode='single'; els.singleWrap.classList.remove('hidden'); els.nextMode.disabled=false; parseSingleIntoRows();
      } else if(els.modeMulti.checked){
        mode='multi'; els.singleWrap.classList.add('hidden'); els.nextMode.disabled=false; rows=[]; updateButtons();
      } else { els.nextMode.disabled=true; }
    }
    els.modeSingle.addEventListener('change', ()=>{ validateMode(); });
    els.modeMulti.addEventListener('change', ()=>{ validateMode(); });
    els.singleAddress.addEventListener('input', ()=>{ if(mode==='single') parseSingleIntoRows(); });
    els.nextMode.addEventListener('click', ()=>{
      if(mode==='single'){ parseSingleIntoRows(); setStep(3); }
      else if(mode==='multi'){ setStep(2); }
      else { setStatus('Select a mode to continue.'); }
    });

    // Step 2: CSV/XLSX
    function parseCSV(text){
      const out=[]; let cur=''; let row=[]; let inQ=false;
      for(let i=0;i<text.length;i++){
        const ch=text[i];
        if(ch==='\"'){ if(inQ && text[i+1]==='\"'){ cur+='\"'; i++; } else { inQ=!inQ; } }
        else if(ch===',' && !inQ){ row.push(cur); cur=''; }
        else if((ch==='\n'||ch==='\r') && !inQ){ if(ch==='\r' && text[i+1]==='\n') i++; row.push(cur); out.push(row); row=[]; cur=''; }
        else { cur+=ch; }
      }
      if(cur.length>0 || row.length>0){ row.push(cur); out.push(row); }
      return out;
    }
    async function handleDataFile(file){
      els.err1.classList.add('hidden'); els.next1.disabled = true; if(!file) return;
      try{
        const name = (file.name||'').toLowerCase(); let arr=[];
        if(name.endsWith('.csv')){ arr = parseCSV(await file.text()); }
        else if(name.endsWith('.xlsx')){
          const wb = XLSX.read(await file.arrayBuffer(),{type:'array'});
          const ws=wb.Sheets[wb.SheetNames[0]];
          arr = XLSX.utils.sheet_to_json(ws,{header:1,raw:false});
        } else throw new Error('Upload .xlsx or .csv');

        const start=(els.hasHeader.value==='yes')?1:0; rows=[]; idx=0;
        for(let r=start;r<arr.length;r++){
          const row=arr[r]||[];
          const nameCell = (row[0]??'').toString().trim();
          const addr = row.slice(1).map(v=>(v??'').toString().trim()).filter(Boolean);
          if(!nameCell && addr.length===0) continue;
          rows.push({name:nameCell, lines:addr});
        }
        if(rows.length>0){ els.next1.disabled=false; setStatus(`Loaded ${rows.length} address${rows.length>1?'es':''}.`); }
        else { els.err1.textContent='No rows found. Check header option or file format.'; els.err1.classList.remove('hidden'); }
      }catch(err){
        els.err1.textContent = (err && err.message) ? err.message : 'Could not read file.'; els.err1.classList.remove('hidden');
      } finally { updateButtons(); }
    }
    els.fileXlsx.addEventListener('change', e=> handleDataFile(e.target.files && e.target.files[0]));
    els.hasHeader.addEventListener('change', ()=>{ const f=els.fileXlsx.files && els.fileXlsx.files[0]; if(f) handleDataFile(f); });
    ;['dragenter','dragover'].forEach(ev=> els.drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); els.drop.classList.add('drag'); }));
    ;['dragleave','drop'].forEach(ev=> els.drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); els.drop.classList.remove('drag'); }));
    els.drop.addEventListener('drop', e=>{ const f=e.dataTransfer.files && e.dataTransfer.files[0]; if(f) handleDataFile(f); });
    els.next1.addEventListener('click', ()=> setStep(3));

    // Step 3: Font (auto-enable on upload; embed same font in PDF)
    function abToBase64(buf){
      let binary = '';
      const bytes = new Uint8Array(buf);
      const chunk = 0x8000;
      for(let i=0;i<bytes.length;i+=chunk){
        binary += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
      }
      return btoa(binary);
    }

    els.useCustomFont.addEventListener('change', ()=>{
      const on=els.useCustomFont.checked;
      els.fileTtf.classList.toggle('hidden', !on);
      if(!on){ ttfBytes=null; ttfBase64=null; fontName=null; customFontLoaded=false; ttfFileName=null; }
    });
    els.fileTtf.addEventListener('change', async e=>{
      const file=e.target.files && e.target.files[0];
      if(!file) return;
      try{
        if(!els.useCustomFont.checked){ els.useCustomFont.checked = true; els.fileTtf.classList.remove('hidden'); }
        ttfBytes=await file.arrayBuffer();
        ttfBase64 = abToBase64(ttfBytes);
        ttfFileName = file.name || 'CustomFont.ttf';
        // Load for preview
        const url=URL.createObjectURL(new Blob([ttfBytes],{type:'font/ttf'}));
        fontName=`UploadedFont_${Math.random().toString(36).slice(2)}`;
        const face=new FontFace(fontName,`url(${url})`);
        await face.load();
        document.fonts.add(face);
        try{ await document.fonts.ready; await document.fonts.load(`24px ${fontName}`);}catch(_){}
        customFontLoaded=true;
        setFontStatus(`Custom font loaded for preview: ${ttfFileName}. It will be embedded in the PDF.`);
        drawPreview();
      }catch(err){
        els.err2.textContent='Could not load font file.';
        els.err2.classList.remove('hidden');
      }
    });
    els.back2.addEventListener('click', ()=> setStep( mode==='multi' ? 2 : 1 ));
    els.next2.addEventListener('click', ()=>{
      if(els.useCustomFont.checked && !customFontLoaded){
        els.err2.textContent='Please upload a TTF or untick the option.';
        els.err2.classList.remove('hidden');
        return;
      }
      els.err2.classList.add('hidden');
      setStep(4);
    });

    // Step 4: Return
    try{
      const saved=localStorage.getItem('envelope_return_v1');
      if(saved){ els.returnBlock.value=saved; }
      const savedUse=localStorage.getItem('envelope_useReturn_v1');
      if(savedUse==='1'){ els.useReturn.checked=true; els.returnBlockWrap.classList.remove('hidden'); }
    }catch(_){}
    els.useReturn.addEventListener('change', ()=>{
      els.returnBlockWrap.classList.toggle('hidden', !els.useReturn.checked);
    });
    els.rememberReturn.addEventListener('change', ()=>{
      if(els.rememberReturn.checked && els.returnBlock.value.trim()){
        try{
          localStorage.setItem('envelope_return_v1', els.returnBlock.value.trim());
          localStorage.setItem('envelope_useReturn_v1', els.useReturn.checked?'1':'0');
        }catch(_){}
      }
    });
    els.returnBlock.addEventListener('input', ()=>{
      if(els.rememberReturn.checked){
        try{ localStorage.setItem('envelope_return_v1', els.returnBlock.value.trim()); }catch(_){}
      }
    });
    els.back3.addEventListener('click', ()=> setStep(3));
    els.next3.addEventListener('click', ()=>{
      if(els.useReturn.checked && !els.returnBlock.value.trim()){
        els.err3.textContent='Please enter the return address or untick the option.';
        els.err3.classList.remove('hidden');
        return;
      }
      els.err3.classList.add('hidden');
      setStep(5);
    });

    // Step 5
    els.back4.addEventListener('click', ()=> setStep(4));
    els.toPreview.addEventListener('click', ()=>{ setStep(6); });

    // Preview (pt→px, same font as PDF when uploaded)
    function drawPreview(){
      const W=els.canvas.width, H=els.canvas.height;
      ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H); ctx.strokeStyle='#e5e7eb'; ctx.strokeRect(0.5,0.5,W-1,H-1);

      const namePt=Number(els.fsRecipient.value)||24;
      const retPt=Number(els.fsReturn.value)||10;
      const namePx = ptToPx(namePt);
      const retPx = ptToPx(retPt);
      const previewFont = customFontLoaded ? `${Math.round(namePx)}px ${fontName}, Arial, sans-serif` : `${Math.round(namePx)}px Arial, sans-serif`;
      const previewFontReturn = customFontLoaded ? `${Math.round(retPx)}px ${fontName}, Arial, sans-serif` : `${Math.round(retPx)}px Arial, sans-serif`;
      const ink = parseColourName(els.inkPreset.value);

      // Return
      if(els.useReturn.checked && els.returnBlock.value.trim()){
        ctx.fillStyle = `rgb(${ink.r},${ink.g},${ink.b})`; ctx.font = previewFontReturn; ctx.textAlign='left';
        const retLeft = inToPx(RET_X_IN); let y = inToPx(RET_Y_IN) + retPx;
        const lines = els.returnBlock.value.replace(/\r/g,'').split('\n');
        for(const line of lines){ ctx.fillText(line, retLeft, y); y += Math.round(retPx*1.2); }
      }

      // Recipient
      ctx.fillStyle=`rgb(${ink.r},${ink.g},${ink.b})`; ctx.font = previewFont;
      const recX=inToPx(REC_X_IN); let recY=inToPx(REC_TOP_IN) + namePx;
      const rcp=rows[idx];
      if(rcp){
        if(rcp.name){ ctx.fillText(rcp.name, recX, recY); recY += Math.round(namePx*1.1); }
        for(const l of rcp.lines){ ctx.fillText(l, recX, recY); recY += Math.round(namePx*1.1); }
      } else {
        ctx.fillStyle='#999'; ctx.font='16px system-ui'; ctx.fillText('Upload .xlsx/.csv (Step 2) to continue…',16,32);
      }

      els.counter.textContent = rows.length?`Preview ${idx+1} / ${rows.length}`:'';
    }

    els.btnPrev.addEventListener('click', ()=>{ if(idx>0){ idx--; drawPreview(); updateButtons(); } });
    els.btnNext.addEventListener('click', ()=>{ if(idx<rows.length-1){ idx++; drawPreview(); updateButtons(); } });
    els.btnBackPreview.addEventListener('click', ()=> setStep(5));

    // PDF via jsPDF with embedded TTF
    async function generatePDF(){
      if(rows.length===0){ setStatus('No addresses to print.'); return; }
      const { jsPDF } = window.jspdf;
      const pageWidth  = mmToPt(ENVELOPE_W_MM);
      const pageHeight = mmToPt(ENVELOPE_H_MM);
      const pdf = new jsPDF({orientation:'landscape', unit:'pt', format:[pageWidth, pageHeight]});

      const recXpt     = REC_X_IN * PT_PER_IN;
      const recTopPt   = REC_TOP_IN * PT_PER_IN;
      const retMarginX = RET_X_IN * PT_PER_IN;
      const retTopPt   = RET_Y_IN * PT_PER_IN;

      const namePt = Number(els.fsRecipient.value)||24;
      const retPt  = Number(els.fsReturn.value)||10;

      const col = parseColourName(els.inkPreset.value);
      pdf.setTextColor(col.r, col.g, col.b);

      // Embed custom TTF if selected, else built-in
      if(els.useCustomFont.checked && ttfBase64){
        try{
          const vfsName = ttfFileName || 'Uploaded.ttf';
          pdf.addFileToVFS(vfsName, ttfBase64);
          pdf.addFont(vfsName, 'UploadedFont', 'normal');
          pdf.setFont('UploadedFont', 'normal');
          setFontStatus(`Using custom font in PDF: ${ttfFileName} ✓`);
        }catch(e){
          setFontStatus('Could not embed custom font — using built-in.');
          pdf.setFont('helvetica', 'normal');
        }
      } else {
        pdf.setFont('helvetica', 'normal');
        setFontStatus('Custom font not selected — using Helvetica.');
      }

      const retLines = (els.useReturn.checked && els.returnBlock.value.trim())
        ? els.returnBlock.value.replace(/\r/g,'').split('\n')
        : [];

      rows.forEach((r, i)=>{
        if(i>0) pdf.addPage([pageWidth, pageHeight], 'landscape');
        // Return
        if(retLines.length){
          let y = retTopPt + retPt;
          pdf.setFontSize(retPt);
          retLines.forEach(line => { pdf.text(line, retMarginX, y, { baseline: 'alphabetic' }); y += retPt*1.2; });
        }
        // Recipient
        let yRec = recTopPt + namePt;
        pdf.setFontSize(namePt);
        if(r.name){ pdf.text(r.name, recXpt, yRec, { baseline: 'alphabetic' }); yRec += namePt*1.1; }
        r.lines.forEach(line => { pdf.text(line, recXpt, yRec, { baseline: 'alphabetic' }); yRec += namePt*1.1; });
      });

      pdf.save('C5_Envelopes.pdf');
      setStatus('PDF downloaded.');
    }

    els.btnGenerate.addEventListener('click', async()=>{
      els.btnGenerate.disabled=true;
      setStatus('Building PDF…');
      try{ await generatePDF(); }
      catch(err){ console.error(err); setStatus('Error: '+(err?.message||err)); }
      finally{ els.btnGenerate.disabled=false; }
    });

    // Live redraw hooks
    ['fsRecipient','fsReturn','useReturn','inkPreset','returnBlock'].forEach(id=>{
      const el=$('#'+id);
      if(el){
        el.addEventListener('input',()=>{ if(!els.previewCard.classList.contains('hidden')){ drawPreview(); updateButtons(); } });
        el.addEventListener('change',()=>{ if(!els.previewCard.classList.contains('hidden')){ drawPreview(); updateButtons(); } });
      }
    });

    // Init
    (function initDefaults(){
      els.modeSingle.checked = true;
      // setup canvas
      els.canvas.width = mmToPx(ENVELOPE_W_MM);
      els.canvas.height = mmToPx(ENVELOPE_H_MM);
      validateMode();
      setStep(1);
    })();
  })();
  </script>
</body>
</html>
