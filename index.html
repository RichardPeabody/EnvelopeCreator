<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Envelope Creator — Wizard (Chevron Stepper)</title>
  <style>
    :root {
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --accent:#2f46ff; --border:#e5e7eb; --shadow:0 10px 30px rgba(15,23,42,.08);
      --chev-bg:#e5e7eb; --chev-active:#60a5fa; --chev-done:#86efac; --chev-text:#1f2937;
      --safe-gap:16px;
    }
    [data-theme="dark"]{
      --bg:#0b1020; --card:#0f152b; --text:#eef2ff; --muted:#9aa3b2; --border:#1e294a; --shadow:0 10px 30px rgba(0,0,0,.6);
      --chev-bg:#1f2937; --chev-active:#2563eb; --chev-done:#16a34a; --chev-text:#e5e7eb;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; overflow-x:hidden; }
    body{ margin:0; background:var(--bg); color:var(--text); font: clamp(14px,1.6vw,16px)/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

    header{ position:sticky; top:0; left:0; right:0; width:100vw; z-index:20;
      background:linear-gradient(135deg,#0b3bff 0%,#7a9bff 100%); color:white; padding:12px 0; box-shadow:var(--shadow); }
    header .row{ display:flex; align-items:center; gap:12px; justify-content:space-between; max-width:1200px; margin:0 auto; padding:0 var(--safe-gap); width:100%; }
    h1{ font-size: clamp(16px, 2.8vw, 18px); margin:0; letter-spacing:.2px; font-weight:700; }

    main{ max-width:1200px; margin:16px auto; padding:0 var(--safe-gap); display:grid; grid-template-columns:1fr 1.08fr; gap:16px; }
    @media (max-width: 900px){ main{ grid-template-columns:1fr; gap:12px; } }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:16px; overflow:hidden; }
    .card h2{ margin:0 0 10px; font-size: clamp(15px, 3vw, 16px); }
    label{ display:block; font-size:12px; color:var(--muted); margin:8px 0 6px; cursor:pointer; }

    input[type="file"], textarea, input[type="number"], input[type="text"], select{
      width:100%; padding:12px; border:1px solid var(--border); border-radius:10px; background:transparent; color:inherit;
    }
    textarea{ min-height:110px; resize:vertical; font-family:inherit; }
    .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 520px){ .row2{ grid-template-columns:1fr; } }

    .btn{ appearance:none; border:0; padding:12px 14px; border-radius:12px; background:var(--accent); color:white; cursor:pointer; font-weight:700;
      letter-spacing:.2px; box-shadow:0 8px 18px rgba(47,70,255,.25); }
    .btn.secondary{ background:transparent; color:var(--accent); border:1px solid var(--accent); box-shadow:none; }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    @media (max-width:520px){ .toolbar{ gap:8px; } .toolbar .btn{ flex:1 1 calc(50% - 4px); min-height:44px; } #controlBar .btn{ flex:0 0 auto; } }

    .status{ font-size:12px; padding:8px 10px; border-radius:10px; background:#e9efff; color:#0b3bff; }
    [data-theme="dark"] .status{ background:#10224a; color:#89a4ff; }

    /* Chevron stepper */
    .chevron-steps{ display:flex; flex-wrap:nowrap; gap:0; overflow:hidden; border-radius:14px; background:transparent; padding:0; margin:0 0 12px; }
    .chevron-steps li{ list-style:none; position:relative; flex:1 1 0; min-width:150px; padding:10px 28px 10px 36px;
      background:var(--chev-bg); color:var(--chev-text); font-weight:700; font-size:12px; user-select:none; display:flex; align-items:center; gap:8px; white-space:nowrap; }
    .chevron-steps li .k{ opacity:.8; font-weight:800; font-variant-numeric:tabular-nums; }
    .chevron-steps li:not(:last-child)::after{
      content:""; position:absolute; right:-18px; top:0; width:0; height:0;
      border-top:22px solid transparent; border-bottom:22px solid transparent; border-left:18px solid var(--chev-bg);
      z-index:2;
    }
    .chevron-steps li:not(:first-child)::before{
      content:""; position:absolute; left:0; top:0; width:0; height:0;
      border-top:22px solid transparent; border-bottom:22px solid transparent; border-left:18px solid var(--bg);
      transform:translateX(-18px);
    }
    .chevron-steps li.active{ background:var(--chev-active); color:#0b1020; }
    .chevron-steps li.active::after{ border-left-color:var(--chev-active); }
    .chevron-steps li.done{ background:var(--chev-done); color:#064e3b; }
    .chevron-steps li.done::after{ border-left-color:var(--chev-done); }
    .chevron-steps li.todo{ opacity:.85; }
    .chevron-steps{ overflow-x:auto; -webkit-overflow-scrolling:touch; scroll-snap-type:x mandatory; }
    .chevron-steps li{ scroll-snap-align:start; }
    .chevron-steps::-webkit-scrollbar{ height:6px; }
    .chevron-steps::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:4px; }

    .previewWrap{ position:relative; border-radius:14px; overflow:hidden; border:1px solid var(--border);
      background: repeating-conic-gradient(#0000 0 90deg, #f3f4f6 0 180deg) 50%/20px 20px; }
    [data-theme="dark"] .previewWrap{ background: repeating-conic-gradient(#0000 0 90deg, #111827 0 180deg) 50%/20px 20px; }
    canvas{ display:block; width:100%; height:auto; background:white; transition:transform .2s ease; transform-origin:center center; }
    .zoombar{ display:flex; align-items:center; gap:10px; margin-top:10px; color:var(--muted); flex-wrap:wrap; }
    input[type="range"]{ width: clamp(180px, 45vw, 240px); }

    .hidden{ display:none !important; }
    .error{ color:#b91c1c; font-size:12px; margin-top:6px; }
    .btn.review { border:2px dashed var(--accent); background:transparent; color:var(--accent); }
    .muted{ color:var(--muted); font-size:12px; }
    .drop{ margin-top:8px; padding:12px; border:1px dashed var(--border); border-radius:10px; text-align:center; }
    .drop.drag{ border-color: var(--accent); background: rgba(47,70,255,.05); }

    /* Intro */
    .introWrap{ position:relative; padding:20px 20px 96px;
      background: radial-gradient(1200px 600px at -10% -10%, #eef1ff, transparent 60%),
                  radial-gradient(1000px 500px at 110% 10%, #dde5ff, transparent 60%);
      border-radius:12px; }
    .printer { width:320px; height:200px; background:linear-gradient(180deg,#2d2d32,#18181c); border-radius:14px; margin:14px auto 20px; position:relative; box-shadow: 0 12px 30px rgba(0,0,0,.25); }
    .printer::after{ content:''; position:absolute; left:50%; transform:translateX(-50%); bottom:-10px; width:220px; height:14px; background:rgba(0,0,0,.35); border-radius:50%; filter:blur(4px); }
    .slot{ position:absolute; top:18px; left:20px; right:20px; height:18px; background:#0d0d10; border-radius:8px; box-shadow: inset 0 2px 6px rgba(255,255,255,.08), inset 0 -2px 6px rgba(0,0,0,.6); }
    .roller{ position:absolute; top:48px; left:40px; right:40px; height:8px; background:repeating-linear-gradient(90deg, #5b5b60 0 10px, #3a3a3f 10px 20px); border-radius:6px; filter:brightness(1.1); animation:roll 1s linear infinite; }
    @keyframes roll{ to{ background-position-x:20px; } }
    .paper { width:250px; height:160px; background:#fff; border:2px solid #e5e7eb; position:absolute; top:28px; left:50%; transform:translateX(-50%); animation:print 4s infinite ease-in-out; border-radius:6px; overflow:hidden; pointer-events:none; z-index:1; }
    .envelopeArt{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; opacity:.95; }
    .envelopeArt svg{ width:85%; height:auto; }
    .addrLines{ position:absolute; top:64px; left:56px; right:30px; height:60px; }
    .line{ height:10px; background:#1f2937; opacity:.85; margin:6px 0; width:0; border-radius:2px; animation: type 3s steps(20,end) infinite; }
    .line:nth-child(2){ animation-delay:.4s; width:0; }
    .line:nth-child(3){ animation-delay:.8s; width:0; }
    @keyframes type{ 0%{ width:0; } 60%{ width:75%; } 100%{ width:75%; } }
    @keyframes print { 0%{ transform:translate(-50%, -40px); opacity:0; } 10%{ opacity:1; } 50%{ transform:translate(-50%, 60px); } 75%{ transform:translate(-50%, 12px); } 100%{ transform:translate(-50%, -40px); opacity:0; } }

    .confetti{ position:absolute; inset:0; pointer-events:none; }
    .confetti i{ position:absolute; width:8px; height:8px; background:var(--accent); top:50%; left:50%; transform:translate(-50%,-50%); opacity:0; border-radius:2px; }
    #introStartBar{ position:relative; z-index:2; margin-top:16px; display:flex; justify-content:center; }
    @media (max-width:430px){ .printer{ width:280px; height:176px; } .paper{ width:220px; height:150px; } .introWrap{ padding-bottom:108px; } .toolbar .btn{ min-height:44px; } }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <h1>✉️ Envelope Creator — Wizard</h1>
      <div class="controls">
        <button id="themeToggle" class="btn secondary" title="Toggle dark mode">Toggle theme</button>
      </div>
    </div>
  </header>

  <main>
    <section class="card" id="wizard">
      <ul class="chevron-steps" id="chev">
        <li id="c0"><span class="k">0.</span> Intro</li>
        <li id="c1"><span class="k">1.</span> Envelope</li>
        <li id="c2"><span class="k">2.</span> Mode</li>
        <li id="c3"><span class="k">3.</span> Data</li>
        <li id="c4"><span class="k">4.</span> Font</li>
        <li id="c5"><span class="k">5.</span> Return</li>
        <li id="c6"><span class="k">6.</span> Options</li>
        <li id="c7"><span class="k">7.</span> Preview & PDF</li>
      </ul>

      <!-- Step 0 -->
      <div id="step0">
        <div class="introWrap">
          <h2 style="position:relative; z-index:1;">Welcome to Envelope Creator</h2>
          <p style="position:relative; z-index:1;">Create and print envelopes with ease. Choose your envelope type, add addresses, and generate ready-to-print PDFs.</p>
          <div class="printer">
            <div class="slot"></div>
            <div class="roller"></div>
            <div class="paper">
              <div class="envelopeArt">
                <svg viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <rect x="10" y="20" width="180" height="80" rx="6" fill="#ffffff" stroke="#cbd5e1" stroke-width="3"/>
                  <rect x="40" y="48" width="100" height="44" rx="2" fill="none" stroke="#e5e7eb" stroke-width="1.5" stroke-dasharray="4 4"/>
                  <rect x="148" y="22" width="30" height="30" rx="3" fill="#ef4444" stroke="#ffffff" stroke-width="3"/>
                  <path d="M152 41 c4 -8 9 -12 13 -12 s9 4 13 12" fill="none" stroke="#ffffff" stroke-width="2"/>
                  <path d="M158 36 l4 -6 l4 6" fill="none" stroke="#ffffff" stroke-width="2"/>
                  <circle cx="165" cy="38" r="13" fill="none" stroke="#475569" stroke-width="1.5"/>
                  <path d="M118 34 C128 30, 138 30, 148 34 S168 38, 178 34" stroke="#64748b" stroke-width="1.5" fill="none"/>
                  <path d="M118 38 C128 34, 138 34, 148 38 S168 42, 178 38" stroke="#64748b" stroke-width="1.5" fill="none"/>
                  <path d="M118 42 C128 38, 138 38, 148 42 S168 46, 178 42" stroke="#64748b" stroke-width="1.5" fill="none"/>
                </svg>
              </div>
              <div class="addrLines">
                <div class="line"></div>
                <div class="line"></div>
                <div class="line"></div>
              </div>
            </div>
            <div class="confetti" id="confetti"></div>
          </div>
          <div class="toolbar" id="introStartBar">
            <button id="next0" class="btn" type="button">Start ▷</button>
          </div>
        </div>
      </div>

      <!-- Step 1 -->
      <div id="step1" class="hidden">
        <h2>Select Envelope Type</h2>
        <label><input type="radio" name="envType" id="envC5" checked /> C5 (229 × 162 mm)</label>
        <label><input type="radio" name="envType" id="envDL" /> DL (220 × 110 mm)</label>
        <div class="toolbar" style="margin-top:14px;">
          <button id="back1" class="btn secondary" type="button">◁ Back</button>
          <button id="nextEnv" class="btn" type="button">Next ▷</button>
        </div>
      </div>

      <!-- Step 2 -->
      <div id="step2" class="hidden">
        <h2>Single address or multiple addresses?</h2>
        <label><input type="radio" name="mode" id="modeSingle" /> Single address (add multiple one by one)</label>
        <label><input type="radio" name="mode" id="modeMulti" /> Multiple addresses (upload a spreadsheet)</label>
        <div id="singleWrap" class="hidden" style="margin-top:10px;">
          <label>Enter recipient(s). One address per block.</label>
          <div id="singleList">
            <textarea class="singleAddress" placeholder="Full Name&#10;Address line 1&#10;Address line 2&#10;Town/City&#10;Postcode&#10;Country"></textarea>
          </div>
          <button id="addSingle" class="btn secondary" type="button" style="margin-top:8px;">+ Add another</button>
        </div>
        <div id="errMode" class="error hidden"></div>
        <div class="toolbar" style="margin-top:14px;">
          <button id="back2a" class="btn secondary" type="button">◁ Back</button>
          <button id="nextMode" class="btn" type="button" disabled>Next ▷</button>
        </div>
      </div>

      <!-- Step 3 -->
      <div id="step3" class="hidden">
        <h2>Upload your data (.xlsx or .csv)</h2>
        <input id="fileXlsx" type="file" accept=".xlsx,.csv" />
        <div class="drop" id="drop">or drag a file here</div>
        <label style="margin-top:12px;">Does your data have a header row?</label>
        <p class="muted" style="margin-top:-6px;">A header row is when the top row of a spreadsheet has labels to describe what data lies below in each column</p>
        <select id="hasHeader">
          <option value="yes">Yes</option>
          <option value="no" selected>No</option>
        </select>
        <div id="err1" class="error hidden"></div>
        <div class="toolbar" style="margin-top:14px;">
          <button id="back3a" class="btn secondary" type="button">◁ Back</button>
          <button id="next1" class="btn" type="button" disabled>Next ▷</button>
        </div>
      </div>

      <!-- Step 4 -->
      <div id="step4" class="hidden">
        <h2>Font</h2>
        <label><input type="checkbox" id="useCustomFont" /> Use a custom TTF (upload below)</label>
        <input id="fileTtf" type="file" accept=".ttf" class="hidden" />
        <p class="muted">If unchecked, the PDF uses built-in Helvetica and the preview uses your system font.</p>
        <div id="err2" class="error hidden"></div>
        <div class="toolbar" style="margin-top:14px;">
          <button id="back2" class="btn secondary" type="button">◁ Back</button>
          <button id="next2" class="btn" type="button">Next ▷</button>
        </div>
        <div id="statusInline" class="status" style="margin-top:8px;"></div>
      </div>

      <!-- Step 5 -->
      <div id="step5" class="hidden">
        <h2>Return Address (top-left, optional)</h2>
        <label><input type="checkbox" id="useReturn" /> Print a return address at the top left</label>
        <div id="returnBlockWrap" class="hidden">
          <label>Return address (each line on its own row)</label>
          <textarea id="returnBlock" placeholder="Your Name&#10;Street&#10;Town, County, POSTCODE, Country"></textarea>
          <label><input type="checkbox" id="rememberReturn" /> Remember this return address on this device</label>
        </div>
        <div id="err3" class="error hidden"></div>
        <div class="toolbar" style="margin-top:14px;">
          <button id="back3" class="btn secondary" type="button">◁ Back</button>
          <button id="next3" class="btn" type="button">Next ▷</button>
        </div>
      </div>

      <!-- Step 6 -->
      <div id="step6" class="hidden">
        <h2>Print Options</h2>
        <div class="row2">
          <div>
            <label>Recipient & return colour</label>
            <select id="inkPreset">
              <option value="black" selected>Black (default)</option>
              <option value="blueblack">Blue-Black (#00004D)</option>
              <option value="blue">Blue</option>
              <option value="red">Red</option>
              <option value="orange">Orange</option>
            </select>
          </div>
          <div>
            <label>Recipient font size (pt)</label>
            <input id="fsRecipient" type="number" value="24" min="8" max="72" />
          </div>
          <div>
            <label>Return font size (pt)</label>
            <input id="fsReturn" type="number" value="10" min="6" max="24" />
          </div>
          <div style="grid-column:1 / -1;">
            <label><input type="checkbox" id="rotate180" /> Rotate output 180° (fix printer flip / Edge)</label>
            <p class="muted" style="margin-top:4px;">Some Browsers or pdf viewers flip the image so your envelope might print backwards.  If so, you can click here to ‘flip’ your PDF during generation. The preview will rotate to match the PDF.</p>
          </div>
        </div>
        <div id="err4" class="error hidden"></div>
        <div class="toolbar" style="margin-top:14px;">
          <button id="back4" class="btn secondary" type="button">◁ Back</button>
          <button id="toPreview" class="btn" type="button">Next ▷</button>
        </div>
      </div>

      <!-- Step 7 -->
      <div id="step7" class="hidden">
        <h2>Preview & PDF</h2>
        <div class="toolbar" id="controlBar" style="margin-bottom:10px;">
          <button id="btnBackPreview" class="btn secondary" type="button" title="Go back to settings">◁ Back to settings</button>
          <span class="status" id="status">Ready.</span>
          <span id="counter" class="muted" style="margin-left:auto"></span>
          <button id="btnGenerate" class="btn" type="button" disabled>⤓ Generate PDF</button>
        </div>
        <div id="statusPreview" class="status" style="margin:8px 0;"></div>
      </div>
    </section>

    <section class="card hidden" id="previewCard">
      <h2>Live Preview (<span id="envLabel">C5</span> landscape)</h2>
      <div class="toolbar" id="reviewBar" style="margin-bottom:0;">
        <button id="btnPrev" class="btn review" type="button" disabled title="Previous address in review">Review ◀ Prev</button>
        <button id="btnNext" class="btn review" type="button" disabled title="Next address in review">Review Next ▶</button>
      </div>
      <div class="zoombar">
        <span>Zoom</span>
        <input id="zoom" type="range" min="60" max="160" value="100" />
        <span id="zoomLabel">100%</span>
      </div>
      <div class="previewWrap" id="previewWrap">
        <canvas id="preview" width="2290" height="1620"></canvas>
      </div>
      <div class="muted" style="margin-top:8px;">Default font is built-in Helvetica unless you upload a .ttf. Selected colour applies to both <b>recipient and return</b> addresses.</div>
    </section>
  </main>

  <!-- Libs -->
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    const MM_PER_IN = 25.4, PT_PER_IN = 72;
    const ENVELOPES = { C5:{W_MM:229,H_MM:162}, DL:{W_MM:220,H_MM:110} };
    let envType = 'C5';

    const REC_X_IN = 2;
    const REC_TOP_IN_MAP = { C5: 2.5, DL: 1.5 };
    const RET_X_IN = 0.5, RET_Y_IN = 0.5;

    let pxPerMM = 10;
    const $ = s => document.querySelector(s);
    const els = {
      steps: Array.from(document.querySelectorAll('.chevron-steps li')),
      step0:$('#step0'), step1:$('#step1'), step2:$('#step2'), step3:$('#step3'), step4:$('#step4'), step5:$('#step5'), step6:$('#step6'), step7:$('#step7'),
      next0:$('#next0'),
      envC5:$('#envC5'), envDL:$('#envDL'), nextEnv:$('#nextEnv'), back1:$('#back1'),
      modeSingle:$('#modeSingle'), modeMulti:$('#modeMulti'), singleWrap:$('#singleWrap'), singleList:$('#singleList'), addSingle:$('#addSingle'), nextMode:$('#nextMode'), errMode:$('#errMode'), back2a:$('#back2a'),
      fileXlsx:$('#fileXlsx'), hasHeader:$('#hasHeader'), next1:$('#next1'), err1:$('#err1'), drop:$('#drop'), back3a:$('#back3a'),
      useCustomFont:$('#useCustomFont'), fileTtf:$('#fileTtf'), back2:$('#back2'), next2:$('#next2'), err2:$('#err2'),
      useReturn:$('#useReturn'), returnBlockWrap:$('#returnBlockWrap'), returnBlock:$('#returnBlock'), rememberReturn:$('#rememberReturn'), back3:$('#back3'), next3:$('#next3'), err3:$('#err3'),
      fsRecipient:$('#fsRecipient'), fsReturn:$('#fsReturn'), inkPreset:$('#inkPreset'), back4:$('#back4'), toPreview:$('#toPreview'), err4:$('#err4'), rotate180:$('#rotate180'),
      status:$('#status'), counter:$('#counter'), btnBackPreview:$('#btnBackPreview'), btnPrev:$('#btnPrev'), btnNext:$('#btnNext'), btnGenerate:$('#btnGenerate'),
      zoom:$('#zoom'), zoomLabel:$('#zoomLabel'),
      wrap:$('#previewWrap'), canvas:$('#preview'), previewCard:$('#previewCard'), envLabel:$('#envLabel'),
      themeToggle:$('#themeToggle'), confetti:$('#confetti')
    };

    const mmToPx = mm => Math.round(mm * pxPerMM);
    const inToPx = inch => Math.round(inch * pxPerMM * MM_PER_IN);
    const ptToPx = pt => pt * ((pxPerMM * MM_PER_IN) / PT_PER_IN);

    function currentStepIndex(){ return [els.step0,els.step1,els.step2,els.step3,els.step4,els.step5,els.step6,els.step7].findIndex(b => !b.classList.contains('hidden')); }
    function updateProgress(n){
      els.steps.forEach((s,i)=>{
        s.classList.remove('done','active','todo');
        if(i===n) s.classList.add('active');
        if(i<n) s.classList.add('done');
        if(i>n) s.classList.add('todo');
      });
      const active = els.steps[n];
      if(active && active.scrollIntoView){ active.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'}); }
    }
    function setStep(n){
      const blocks=[els.step0,els.step1,els.step2,els.step3,els.step4,els.step5,els.step6,els.step7];
      blocks.forEach((c,i)=> c.classList.toggle('hidden', i!==n));
      updateProgress(n);
      els.previewCard.classList.toggle('hidden', n!==7);
      setStatus(`On step ${n}`);
      if(n===7){ drawPreview(); updateButtons(); applyZoom(); applyRotationPreview(); }
      attachBackHandlers();
    }

    function setStatus(msg){ if(els.status) els.status.textContent = msg; const si = document.getElementById('statusInline'); if (si) si.textContent = msg; }
    function setFontStatus(msg){ const si = document.getElementById('statusInline'); if (si) si.textContent = msg; const sp = document.getElementById('statusPreview'); if (sp) sp.textContent = msg; }
    const parseColourName = name => ({blueblack:{r:0,g:0,b:77}, blue:{r:0,g:87,b:255}, red:{r:227,g:27,b:35}, orange:{r:249,g:115,b:22}}[name]||{r:0,g:0,b:0});

    function applyEnvelope(type){
      envType = type;
      const s = ENVELOPES[envType];
      els.canvas.width = mmToPx(s.W_MM);
      els.canvas.height = mmToPx(s.H_MM);
      els.envLabel.textContent = envType;
      drawPreview();
    }

    let rows = []; let idx = 0; let mode = null;
    let customFontLoaded = false; let ttfBase64 = null;

    function attachBackHandlers(){
      const buttons = ['back1','back2a','back3a','back2','back3','back4','btnBackPreview']
        .map(id => document.getElementById(id))
        .filter(Boolean);
      buttons.forEach(btn => {
        btn.onclick = () => {
          const i = currentStepIndex();
          if(i > 0) setStep(i - 1);
        };
      });
    }

    function updateButtons(){
      const ready = rows.length>0;
      els.btnGenerate.disabled = !ready;
      els.btnPrev.disabled = idx<=0;
      els.btnNext.disabled = idx>=rows.length-1;
      els.counter.textContent = ready ? `Preview ${idx+1} / ${rows.length}` : '';
    }

    els.themeToggle.addEventListener('click', ()=>{
      const cur=document.documentElement.getAttribute('data-theme')||'light';
      document.documentElement.setAttribute('data-theme',cur==='light'?'dark':'light');
    });

    function applyZoom(){
      const z=parseInt(els.zoom.value,10)/100;
      els.wrap.style.transform=`scale(${z})`;
      els.wrap.style.transformOrigin='top left';
      els.zoomLabel.textContent=`${Math.round(z*100)}%`
    }
    els.zoom.addEventListener('input', applyZoom);

    function applyRotationPreview(){ els.canvas.style.transform = (els.rotate180 && els.rotate180.checked) ? 'rotate(180deg)' : 'none'; }
    if(els.rotate180){ els.rotate180.addEventListener('change', ()=>{ applyRotationPreview(); drawPreview(); }); }

    function burstConfetti(){
      const c = els.confetti; if(!c) return;
      c.innerHTML = '';
      for(let i=0;i<24;i++){
        const dot = document.createElement('i');
        const angle = (Math.PI*2) * (i/24);
        const dist = 80 + Math.random()*40;
        const x = Math.cos(angle)*dist;
        const y = Math.sin(angle)*dist;
        dot.style.background = `hsl(${Math.round(200+ i*6)}, 80%, 55%)`;
        dot.style.transition = 'transform 700ms ease, opacity 700ms ease';
        c.appendChild(dot);
        requestAnimationFrame(()=>{
          dot.style.opacity = '1';
          dot.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) rotate(${Math.random()*180}deg)`;
          setTimeout(()=>{ dot.style.opacity='0'; }, 500);
        });
      }
      setTimeout(()=>{ c.innerHTML=''; }, 900);
    }
    els.next0.addEventListener('click', ()=>{ burstConfetti(); setTimeout(()=> setStep(1), 150); });

    function readEnvSelection(){ applyEnvelope(els.envDL.checked ? 'DL' : 'C5'); }
    els.envC5.addEventListener('change', readEnvSelection);
    els.envDL.addEventListener('change', readEnvSelection);
    els.nextEnv.addEventListener('click', ()=>{ readEnvSelection(); setStep(2); });

    function parseSinglesIntoRows(){
      const blocks = Array.from(els.singleList.querySelectorAll('textarea.singleAddress'));
      const out = [];
      blocks.forEach(area=>{
        const lines = area.value.replace(/\r/g,'').split('\n').map(s=>s.trim());
        const nonEmpty = lines.filter(Boolean);
        if(nonEmpty.length>0){
          const name = nonEmpty[0];
          const addr = nonEmpty.slice(1);
          out.push({ name, lines: addr });
        }
      });
      rows = out; idx = 0; updateButtons();
    }
    function addSingleBlock(){
      const ta = document.createElement('textarea');
      ta.className = 'singleAddress';
      ta.placeholder = "Full Name\nAddress line 1\nAddress line 2\nTown/City\nPostcode\nCountry";
      ta.addEventListener('input', ()=>{ if(mode==='single'){ parseSinglesIntoRows(); }});
      els.singleList.appendChild(ta);
    }
    els.addSingle.addEventListener('click', (e)=>{ e.preventDefault(); addSingleBlock(); });

    function validateMode(){
      if(els.modeSingle.checked){
        mode='single'; els.singleWrap.classList.remove('hidden'); els.nextMode.disabled=false; parseSinglesIntoRows();
      } else if(els.modeMulti.checked){
        mode='multi'; els.singleWrap.classList.add('hidden'); els.nextMode.disabled=false; rows=[]; updateButtons();
      } else { els.nextMode.disabled=true; }
    }
    ['change','input'].forEach(ev=>{
      els.modeSingle.addEventListener(ev, validateMode);
      els.modeMulti.addEventListener(ev, validateMode);
    });
    els.singleList.addEventListener('input', ()=>{ if(mode==='single') parseSinglesIntoRows(); });
    els.singleList.querySelector('textarea.singleAddress').addEventListener('input', ()=>{ if(mode==='single') parseSinglesIntoRows(); });

    els.nextMode.addEventListener('click', ()=>{
      if(mode==='single'){ parseSinglesIntoRows(); setStep(4); }
      else if(mode==='multi'){ setStep(3); }
      else { setStatus('Select a mode to continue.'); }
    });
    els.back2a.addEventListener('click', ()=> setStep(1));

    function parseCSV(text){
      const out=[]; let cur=''; let row=[]; let inQ=false;
      for(let i=0;i<text.length;i++){
        const ch=text[i];
        if(ch=='"'){ if(inQ && text[i+1]=='"'){ cur+='"'; i++; } else { inQ=!inQ; } }
        else if(ch===',' && !inQ){ row.push(cur); cur=''; }
        else if((ch==='\n'||ch==='\r') && !inQ){ if(ch==='\r' && text[i+1]==='\n') i++; row.push(cur); out.push(row); row=[]; cur=''; }
        else { cur+=ch; }
      }
      if(cur.length>0 || row.length>0){ row.push(cur); out.push(row); }
      return out;
    }
    async function handleDataFile(file){
      els.err1.classList.add('hidden'); els.next1.disabled = true; if(!file) return;
      try{
        const name = (file.name||'').toLowerCase(); let arr=[];
        if(name.endsWith('.csv')){ arr = parseCSV(await file.text()); }
        else if(name.endsWith('.xlsx')){
          const wb = XLSX.read(await file.arrayBuffer(),{type:'array'});
          const ws=wb.Sheets[wb.SheetNames[0]];
          arr = XLSX.utils.sheet_to_json(ws,{header:1,raw:false});
        } else throw new Error('Upload .xlsx or .csv');

        const start=(els.hasHeader.value==='yes')?1:0; rows=[]; idx=0;
        for(let r=start;r<arr.length;r++){
          const row=arr[r]||[];
          const nameCell = (row[0]??'').toString().trim();
          const addr = row.slice(1).map(v=>(v??'').toString().trim()).filter(Boolean);
          if(!nameCell && addr.length===0) continue;
          rows.push({name:nameCell, lines:addr});
        }
        if(rows.length>0){ els.next1.disabled=false; setStatus(`Loaded ${rows.length} address${rows.length>1?'es':''}.`); }
        else { els.err1.textContent='No rows found. Check header option or file format.'; els.err1.classList.remove('hidden'); }
      }catch(err){
        els.err1.textContent = (err && err.message) ? err.message : 'Could not read file.'; els.err1.classList.remove('hidden');
      } finally { updateButtons(); }
    }
    els.fileXlsx.addEventListener('change', e=> handleDataFile(e.target.files && e.target.files[0]));
    els.hasHeader.addEventListener('change', ()=>{ const f=els.fileXlsx.files && els.fileXlsx.files[0]; if(f) handleDataFile(f); });
    ['dragenter','dragover'].forEach(ev=> els.drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); els.drop.classList.add('drag'); }));
    ['dragleave','drop'].forEach(ev=> els.drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); els.drop.classList.remove('drag'); }));
    els.drop.addEventListener('drop', e=>{ const f=e.dataTransfer.files && e.dataTransfer.files[0]; if(f) handleDataFile(f); });
    els.next1.addEventListener('click', ()=> setStep(4));
    els.back3a.addEventListener('click', ()=> setStep(2));

    function abToBase64(buf){
      let binary = '';
      const bytes = new Uint8Array(buf);
      const chunk = 0x8000;
      for(let i=0;i<bytes.length;i+=chunk){
        binary += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
      }
      return btoa(binary);
    }

    els.useCustomFont.addEventListener('change', ()=>{
      const on=els.useCustomFont.checked;
      els.fileTtf.classList.toggle('hidden', !on);
      if(!on){ ttfBase64=null; customFontLoaded=false; window.__fontName=null; }
    });
    els.fileTtf.addEventListener('change', async e=>{
      const file=e.target.files && e.target.files[0];
      if(!file) return;
      try{
        if(!els.useCustomFont.checked){ els.useCustomFont.checked = true; els.fileTtf.classList.remove('hidden'); }
        const buf=await file.arrayBuffer();
        ttfBase64 = abToBase64(buf);
        const url=URL.createObjectURL(new Blob([buf],{type:'font/ttf'}));
        const nameHint=(file.name||'CustomFont.ttf').replace(/\W+/g,'_');
        window.__fontName = `UploadedFont_${nameHint}_${Math.random().toString(36).slice(2)}`;
        const face=new FontFace(window.__fontName,`url(${url})`);
        await face.load();
        document.fonts.add(face);
        try{ await document.fonts.ready; await document.fonts.load(`24px ${window.__fontName}`);}catch(_){}
        customFontLoaded=true;
        setFontStatus(`Custom font loaded for preview: ${file.name}. It will be embedded in the PDF.`);
        drawPreview();
      }catch(err){
        els.err2.textContent='Could not load font file.';
        els.err2.classList.remove('hidden');
      }
    });
    els.next2.addEventListener('click', ()=>{
      if(els.useCustomFont.checked && !customFontLoaded){
        els.err2.textContent='Please upload a TTF or untick the option.';
        els.err2.classList.remove('hidden');
        return;
      }
      els.err2.classList.add('hidden');
      setStep(5);
    });
    els.back2.addEventListener('click', ()=> setStep(3));

    try{
      const saved=localStorage.getItem('envelope_return_v1');
      if(saved){ els.returnBlock.value=saved; }
      const savedUse=localStorage.getItem('envelope_useReturn_v1');
      if(savedUse==='1'){ els.useReturn.checked=true; els.returnBlockWrap.classList.remove('hidden'); }
    }catch(_){}
    els.useReturn.addEventListener('change', ()=>{ els.returnBlockWrap.classList.toggle('hidden', !els.useReturn.checked); });
    els.rememberReturn.addEventListener('change', ()=>{
      if(els.rememberReturn.checked && els.returnBlock.value.trim()){
        try{ localStorage.setItem('envelope_return_v1', els.returnBlock.value.trim()); localStorage.setItem('envelope_useReturn_v1', els.useReturn.checked?'1':'0'); }catch(_){}
      }
    });
    els.returnBlock.addEventListener('input', ()=>{ if(els.rememberReturn.checked){ try{ localStorage.setItem('envelope_return_v1', els.returnBlock.value.trim()); }catch(_){} } });
    els.back3.addEventListener('click', ()=> setStep(4));
    els.next3.addEventListener('click', ()=>{
      if(els.useReturn.checked && !els.returnBlock.value.trim()){
        els.err3.textContent='Please enter the return address or untick the option.';
        els.err3.classList.remove('hidden');
        return;
      }
      els.err3.classList.add('hidden');
      setStep(6);
    });

    els.back4.addEventListener('click', ()=> setStep(5));
    els.toPreview.addEventListener('click', ()=>{ setStep(7); });

    function drawPreview(){
      const s = ENVELOPES[envType];
      const canvas = els.canvas;
      canvas.width = mmToPx(s.W_MM);
      canvas.height = mmToPx(s.H_MM);

      const W=canvas.width, H=canvas.height;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H); ctx.strokeStyle='#e5e7eb'; ctx.strokeRect(0.5,0.5,W-1,H-1);

      const namePt=Number(els.fsRecipient.value)||24;
      const retPt=Number(els.fsReturn.value)||10;
      const namePx = ptToPx(namePt);
      const retPx = ptToPx(retPt);
      const previewFont = (customFontLoaded && window.__fontName) ? `${Math.round(namePx)}px ${window.__fontName}, Arial, sans-serif` : `${Math.round(namePx)}px Arial, sans-serif`;
      const previewFontReturn = (customFontLoaded && window.__fontName) ? `${Math.round(retPx)}px ${window.__fontName}, Arial, sans-serif` : `${Math.round(retPx)}px Arial, sans-serif`;
      const ink = parseColourName(els.inkPreset.value);

      if(els.useReturn.checked && els.returnBlock.value.trim()){
        ctx.fillStyle = `rgb(${ink.r},${ink.g},${ink.b})`; ctx.font = previewFontReturn; ctx.textAlign='left';
        const retLeft = inToPx(RET_X_IN); let y = inToPx(RET_Y_IN) + retPx;
        ctx.fillText('Return Address:', retLeft, y);
        y += Math.round(retPx*1.2);
        els.returnBlock.value.replace(/\r/g,'').split('\n').forEach(line => { ctx.fillText(line, retLeft, y); y += Math.round(retPx*1.2); });
      }

      const recTopIn = REC_TOP_IN_MAP[envType] || 1.5;
      ctx.fillStyle=`rgb(${ink.r},${ink.g},${ink.b})`; ctx.font = previewFont;
      const recX=inToPx(REC_X_IN); let recY=inToPx(recTopIn) + namePx;
      const rcp=rows[idx];
      if(rcp){
        if(rcp.name){ ctx.fillText(rcp.name, recX, recY); recY += Math.round(namePx*1.1); }
        rcp.lines.forEach(l => { ctx.fillText(l, recX, recY); recY += Math.round(namePx*1.1); });
      } else {
        ctx.fillStyle='#999'; ctx.font='16px system-ui'; ctx.fillText('Enter addresses (Single) or upload .xlsx/.csv (Multi)…',16,32);
      }
      els.counter.textContent = rows.length?`Preview ${idx+1} / ${rows.length}`:'';
    }

    els.btnPrev.addEventListener('click', ()=>{ if(idx>0){ idx--; drawPreview(); updateButtons(); } });
    els.btnNext.addEventListener('click', ()=>{ if(idx<rows.length-1){ idx++; drawPreview(); updateButtons(); } });
    els.btnBackPreview.addEventListener('click', ()=> setStep(6));

    async function generatePDF(){
      if(rows.length===0){ setStatus('No addresses to print.'); return; }
      const { jsPDF } = window.jspdf;
      const s = ENVELOPES[envType];
      const pageWidth  = (s.W_MM / MM_PER_IN) * PT_PER_IN;
      const pageHeight = (s.H_MM / MM_PER_IN) * PT_PER_IN;
      const pdf = new jsPDF({orientation:'landscape', unit:'pt', format:[pageWidth, pageHeight]});

      const recXpt     = REC_X_IN * PT_PER_IN;
      const recTopPt   = (REC_TOP_IN_MAP[envType] || 1.5) * PT_PER_IN;
      const retMarginX = RET_X_IN * PT_PER_IN;
      const retTopPt   = RET_Y_IN * PT_PER_IN;

      const namePt = Number(els.fsRecipient.value)||24;
      const retPt  = Number(els.fsReturn.value)||10;

      const col = parseColourName(els.inkPreset.value);
      pdf.setTextColor(col.r, col.g, col.b);

      const useCustom = els.useCustomFont.checked && ttfBase64;
      if(useCustom){
        try{
          const vfsName = 'Uploaded.ttf';
          pdf.addFileToVFS(vfsName, ttfBase64);
          pdf.addFont(vfsName, 'UploadedFont', 'normal');
          pdf.setFont('UploadedFont', 'normal');
          setFontStatus(`Using custom font in PDF ✓`);
        }catch(e){
          setFontStatus('Could not embed custom font — using built-in.');
          pdf.setFont('helvetica', 'normal');
        }
      } else {
        pdf.setFont('helvetica', 'normal');
        setFontStatus('Custom font not selected — using Helvetica.');
      }

      const rotate = !!(els.rotate180 && els.rotate180.checked);
      const textOut = (str, x, y, size) => {
        if(!str) return;
        pdf.setFontSize(size);
        if(rotate){ pdf.text(str, pageWidth - x, pageHeight - y, { baseline: 'alphabetic', angle: 180 }); }
        else { pdf.text(str, x, y, { baseline: 'alphabetic' }); }
      };

      const retLines = (els.useReturn.checked && els.returnBlock.value.trim())
        ? els.returnBlock.value.replace(/\r/g,'').split('\n')
        : [];

      rows.forEach((r, i)=>{
        if(i>0) pdf.addPage([pageWidth, pageHeight], 'landscape');
        if(retLines.length){
          let y = retTopPt + retPt;
          textOut('Return Address:', retMarginX, y, retPt);
          y += retPt*1.2;
          retLines.forEach(line => { textOut(line, retMarginX, y, retPt); y += retPt*1.2; });
        }
        let yRec = recTopPt + namePt;
        textOut(r.name || '', recXpt, yRec, namePt);
        if(r.name) yRec += namePt*1.1;
        r.lines.forEach(line => { textOut(line, recXpt, yRec, namePt); yRec += namePt*1.1; });
      });

      pdf.save(`Envelopes_${envType}.pdf`);
      setStatus('PDF downloaded.');
    }

    els.btnGenerate.addEventListener('click', async()=>{
      els.btnGenerate.disabled=true;
      setStatus('Building PDF…');
      try{ await generatePDF(); }
      catch(err){ console.error(err); setStatus('Error: '+(err?.message||err)); }
      finally{ els.btnGenerate.disabled=false; }
    });

    ['fsRecipient','fsReturn','useReturn','inkPreset','returnBlock'].forEach(id=>{
      const el=$('#'+id);
      if(el){
        el.addEventListener('input',()=>{ if(!els.previewCard.classList.contains('hidden')){ drawPreview(); updateButtons(); } });
        el.addEventListener('change',()=>{ if(!els.previewCard.classList.contains('hidden')){ drawPreview(); updateButtons(); } });
      }
    });

    (function initDefaults(){
      applyEnvelope('C5');
      setStep(0);
    })();
  });
  </script>
</body>
</html>
